var planArr = [{
        "PackageId": 4243,
        "PackageName": "线上一证通",
        "PackageFullName": "线上一证通",
        "ProductId": 112589,
        "RepaymentPeriod": 12,
        "DownPaymentRate": 0.3,
        "FinalPaymentRate": 0,
        "ServiceFee": 50,
        "DownPayment": null,
        "DownPaymentText": "3.09万",
        "DownPaymentNum": 30900,
        "FinalPaymentAmountText": "0元",
        "FinalPaymentAmountNum": 0,
        "TotalCostText": "4015元",
        "TotalCostNum": 4015,
        "InterestRateText": "0.46%",
        "MonthlyPaymentText": "6339元",
        "MonthlyPaymentNum": 6339,
        "TotalInterestText": "3965元",
        "TotalInterestNum": 3965,
        "ServiceFeeText": "50元",
        "ServiceFeeNum": 50,
        "EarnMoneyText": null,
        "EarnMoneyNum": 0,
        "LoanAmountText": "7.21万",
        "LoanAmountNum": 72100,
        "TotalPay": 107015
    },
    {
        "PackageId": 4243,
        "PackageName": "线上一证通",
        "PackageFullName": "线上一证通",
        "ProductId": 112590,
        "RepaymentPeriod": 12,
        "DownPaymentRate": 0.4,
        "FinalPaymentRate": 0,
        "ServiceFee": 100,
        "DownPayment": null,
        "DownPaymentText": "4.12万",
        "DownPaymentNum": 41200,
        "FinalPaymentAmountText": "0元",
        "FinalPaymentAmountNum": 0,
        "TotalCostText": "3498元",
        "TotalCostNum": 3498,
        "InterestRateText": "0.46%",
        "MonthlyPaymentText": "5433元",
        "MonthlyPaymentNum": 5433,
        "TotalInterestText": "3398元",
        "TotalInterestNum": 3398,
        "ServiceFeeText": "100元",
        "ServiceFeeNum": 100,
        "EarnMoneyText": null,
        "EarnMoneyNum": 0,
        "LoanAmountText": "6.18万",
        "LoanAmountNum": 61800,
        "TotalPay": 106498
    },
    {
        "PackageId": 4243,
        "PackageName": "线上一证通",
        "PackageFullName": "线上一证通",
        "ProductId": 112591,
        "RepaymentPeriod": 24,
        "DownPaymentRate": 0.3,
        "FinalPaymentRate": 0,
        "ServiceFee": 500,
        "DownPayment": null,
        "DownPaymentText": "3.09万",
        "DownPaymentNum": 30900,
        "FinalPaymentAmountText": "0元",
        "FinalPaymentAmountNum": 0,
        "TotalCostText": "4315元",
        "TotalCostNum": 4315,
        "InterestRateText": "0.22%",
        "MonthlyPaymentText": "3163元",
        "MonthlyPaymentNum": 3163,
        "TotalInterestText": "3815元",
        "TotalInterestNum": 3815,
        "ServiceFeeText": "500元",
        "ServiceFeeNum": 500,
        "EarnMoneyText": null,
        "EarnMoneyNum": 0,
        "LoanAmountText": "7.21万",
        "LoanAmountNum": 72100,
        "TotalPay": 107315
    },
    {
        "PackageId": 4243,
        "PackageName": "线上一证通",
        "PackageFullName": "线上一证通",
        "ProductId": 112592,
        "RepaymentPeriod": 24,
        "DownPaymentRate": 0.4,
        "FinalPaymentRate": 0,
        "ServiceFee": 1000,
        "DownPayment": null,
        "DownPaymentText": "4.12万",
        "DownPaymentNum": 41200,
        "FinalPaymentAmountText": "0元",
        "FinalPaymentAmountNum": 0,
        "TotalCostText": "4270元",
        "TotalCostNum": 4270,
        "InterestRateText": "0.22%",
        "MonthlyPaymentText": "2711元",
        "MonthlyPaymentNum": 2711,
        "TotalInterestText": "3270元",
        "TotalInterestNum": 3270,
        "ServiceFeeText": "1000元",
        "ServiceFeeNum": 1000,
        "EarnMoneyText": null,
        "EarnMoneyNum": 0,
        "LoanAmountText": "6.18万",
        "LoanAmountNum": 61800,
        "TotalPay": 107270
    },
    {
        "PackageId": 4243,
        "PackageName": "线上一证通",
        "PackageFullName": "线上一证通",
        "ProductId": 112593,
        "RepaymentPeriod": 36,
        "DownPaymentRate": 0.3,
        "FinalPaymentRate": 0,
        "ServiceFee": 20,
        "DownPayment": null,
        "DownPaymentText": "3.09万",
        "DownPaymentNum": 30900,
        "FinalPaymentAmountText": "0元",
        "FinalPaymentAmountNum": 0,
        "TotalCostText": "8065元",
        "TotalCostNum": 8065,
        "InterestRateText": "0.31%",
        "MonthlyPaymentText": "2226元",
        "MonthlyPaymentNum": 2226,
        "TotalInterestText": "8045元",
        "TotalInterestNum": 8045,
        "ServiceFeeText": "20元",
        "ServiceFeeNum": 20,
        "EarnMoneyText": null,
        "EarnMoneyNum": 0,
        "LoanAmountText": "7.21万",
        "LoanAmountNum": 72100,
        "TotalPay": 111065
    },
    {
        "PackageId": 4243,
        "PackageName": "线上一证通",
        "PackageFullName": "线上一证通",
        "ProductId": 112594,
        "RepaymentPeriod": 36,
        "DownPaymentRate": 0.4,
        "FinalPaymentRate": 0,
        "ServiceFee": 200,
        "DownPayment": null,
        "DownPaymentText": "4.12万",
        "DownPaymentNum": 41200,
        "FinalPaymentAmountText": "0元",
        "FinalPaymentAmountNum": 0,
        "TotalCostText": "7095元",
        "TotalCostNum": 7095,
        "InterestRateText": "0.31%",
        "MonthlyPaymentText": "1908元",
        "MonthlyPaymentNum": 1908,
        "TotalInterestText": "6895元",
        "TotalInterestNum": 6895,
        "ServiceFeeText": "200元",
        "ServiceFeeNum": 200,
        "EarnMoneyText": null,
        "EarnMoneyNum": 0,
        "LoanAmountText": "6.18万",
        "LoanAmountNum": 61800,
        "TotalPay": 110095
    },
    {
        "PackageId": 4244,
        "PackageName": "两证通",
        "PackageFullName": "两证通",
        "ProductId": 112595,
        "RepaymentPeriod": 12,
        "DownPaymentRate": 0.3,
        "FinalPaymentRate": 0,
        "ServiceFee": 0,
        "DownPayment": null,
        "DownPaymentText": "3.09万",
        "DownPaymentNum": 30900,
        "FinalPaymentAmountText": "0元",
        "FinalPaymentAmountNum": 0,
        "TotalCostText": "1968元",
        "TotalCostNum": 1968,
        "InterestRateText": "0.23%",
        "MonthlyPaymentText": "6172元",
        "MonthlyPaymentNum": 6172,
        "TotalInterestText": "1968元",
        "TotalInterestNum": 1968,
        "ServiceFeeText": "0元",
        "ServiceFeeNum": 0,
        "EarnMoneyText": null,
        "EarnMoneyNum": 0,
        "LoanAmountText": "7.21万",
        "LoanAmountNum": 72100,
        "TotalPay": 104968
    },
    {
        "PackageId": 4244,
        "PackageName": "两证通",
        "PackageFullName": "两证通",
        "ProductId": 112596,
        "RepaymentPeriod": 24,
        "DownPaymentRate": 0.4,
        "FinalPaymentRate": 0,
        "ServiceFee": 0,
        "DownPayment": null,
        "DownPaymentText": "4.12万",
        "DownPaymentNum": 41200,
        "FinalPaymentAmountText": "0元",
        "FinalPaymentAmountNum": 0,
        "TotalCostText": "3270元",
        "TotalCostNum": 3270,
        "InterestRateText": "0.22%",
        "MonthlyPaymentText": "2711元",
        "MonthlyPaymentNum": 2711,
        "TotalInterestText": "3270元",
        "TotalInterestNum": 3270,
        "ServiceFeeText": "0元",
        "ServiceFeeNum": 0,
        "EarnMoneyText": null,
        "EarnMoneyNum": 0,
        "LoanAmountText": "6.18万",
        "LoanAmountNum": 61800,
        "TotalPay": 106270
    },
    {
        "PackageId": 4244,
        "PackageName": "两证通",
        "PackageFullName": "两证通",
        "ProductId": 112597,
        "RepaymentPeriod": 36,
        "DownPaymentRate": 0.5,
        "FinalPaymentRate": 0,
        "ServiceFee": 0,
        "DownPayment": null,
        "DownPaymentText": "5.15万",
        "DownPaymentNum": 51500,
        "FinalPaymentAmountText": "0元",
        "FinalPaymentAmountNum": 0,
        "TotalCostText": "4066元",
        "TotalCostNum": 4066,
        "InterestRateText": "0.22%",
        "MonthlyPaymentText": "1544元",
        "MonthlyPaymentNum": 1544,
        "TotalInterestText": "4066元",
        "TotalInterestNum": 4066,
        "ServiceFeeText": "0元",
        "ServiceFeeNum": 0,
        "EarnMoneyText": null,
        "EarnMoneyNum": 0,
        "LoanAmountText": "5.15万",
        "LoanAmountNum": 51500,
        "TotalPay": 107066
    },
    {
        "PackageId": 4245,
        "PackageName": "线上淘车定制",
        "PackageFullName": "线上淘车定制",
        "ProductId": 112598,
        "RepaymentPeriod": 12,
        "DownPaymentRate": 0.2,
        "FinalPaymentRate": 0,
        "ServiceFee": 0,
        "DownPayment": null,
        "DownPaymentText": "2.06万",
        "DownPaymentNum": 20600,
        "FinalPaymentAmountText": "0元",
        "FinalPaymentAmountNum": 0,
        "TotalCostText": "1345元",
        "TotalCostNum": 1345,
        "InterestRateText": "0.14%",
        "MonthlyPaymentText": "6979元",
        "MonthlyPaymentNum": 6979,
        "TotalInterestText": "1345元",
        "TotalInterestNum": 1345,
        "ServiceFeeText": "0元",
        "ServiceFeeNum": 0,
        "EarnMoneyText": null,
        "EarnMoneyNum": 0,
        "LoanAmountText": "8.24万",
        "LoanAmountNum": 82400,
        "TotalPay": 104345
    },
    {
        "PackageId": 4245,
        "PackageName": "线上淘车定制",
        "PackageFullName": "线上淘车定制",
        "ProductId": 112599,
        "RepaymentPeriod": 24,
        "DownPaymentRate": 0.2,
        "FinalPaymentRate": 0,
        "ServiceFee": 0,
        "DownPayment": null,
        "DownPaymentText": "2.06万",
        "DownPaymentNum": 20600,
        "FinalPaymentAmountText": "0元",
        "FinalPaymentAmountNum": 0,
        "TotalCostText": "2600元",
        "TotalCostNum": 2600,
        "InterestRateText": "0.13%",
        "MonthlyPaymentText": "3542元",
        "MonthlyPaymentNum": 3542,
        "TotalInterestText": "2600元",
        "TotalInterestNum": 2600,
        "ServiceFeeText": "0元",
        "ServiceFeeNum": 0,
        "EarnMoneyText": null,
        "EarnMoneyNum": 0,
        "LoanAmountText": "8.24万",
        "LoanAmountNum": 82400,
        "TotalPay": 105600
    },
    {
        "PackageId": 4245,
        "PackageName": "线上淘车定制",
        "PackageFullName": "线上淘车定制",
        "ProductId": 112600,
        "RepaymentPeriod": 24,
        "DownPaymentRate": 0.3,
        "FinalPaymentRate": 0,
        "ServiceFee": 0,
        "DownPayment": null,
        "DownPaymentText": "3.09万",
        "DownPaymentNum": 30900,
        "FinalPaymentAmountText": "0元",
        "FinalPaymentAmountNum": 0,
        "TotalCostText": "3042元",
        "TotalCostNum": 3042,
        "InterestRateText": "0.18%",
        "MonthlyPaymentText": "3131元",
        "MonthlyPaymentNum": 3131,
        "TotalInterestText": "3042元",
        "TotalInterestNum": 3042,
        "ServiceFeeText": "0元",
        "ServiceFeeNum": 0,
        "EarnMoneyText": null,
        "EarnMoneyNum": 0,
        "LoanAmountText": "7.21万",
        "LoanAmountNum": 72100,
        "TotalPay": 106042
    },
    {
        "PackageId": 4245,
        "PackageName": "线上淘车定制",
        "PackageFullName": "线上淘车定制",
        "ProductId": 112601,
        "RepaymentPeriod": 36,
        "DownPaymentRate": 0.2,
        "FinalPaymentRate": 0,
        "ServiceFee": 0,
        "DownPayment": null,
        "DownPaymentText": "2.06万",
        "DownPaymentNum": 20600,
        "FinalPaymentAmountText": "0元",
        "FinalPaymentAmountNum": 0,
        "TotalCostText": "6506元",
        "TotalCostNum": 6506,
        "InterestRateText": "0.22%",
        "MonthlyPaymentText": "2470元",
        "MonthlyPaymentNum": 2470,
        "TotalInterestText": "6506元",
        "TotalInterestNum": 6506,
        "ServiceFeeText": "0元",
        "ServiceFeeNum": 0,
        "EarnMoneyText": null,
        "EarnMoneyNum": 0,
        "LoanAmountText": "8.24万",
        "LoanAmountNum": 82400,
        "TotalPay": 109506
    }
];
var dealwithdata = {
    rulersEvent: [],
    data: null,
    unique: function(input) {
        var destination = [],
            json = {};
        for (var i = 0, len = input.length; i < len; i++) {
            if (!json[input[i]]) {
                destination.push(input[i]);
                json[input[i]] = 1;
            }
        }
        return destination;
    },
    init: function(plans) {
        var that = this;
        var obj = {},
            item,
            pkid; //packageid
        for (var i = 0, len = planArr.length; i < len; i++) {
            item = plans[i];
            pkid = item.PackageId;
            if (!obj[pkid]) {
                obj[pkid] = {
                    pkid: item.PackageId,
                    pkname: item.PackageName,
                    products: [], // [item.ProductId],
                    rps: [], // [item.RepaymentPeriod],
                    dprs: [] // [item.DownPaymentRate]
                };
            }
            var dpr = parseFloat(item.DownPaymentRate),
                rp = parseInt(item.RepaymentPeriod);

            obj[pkid].products.push({
                pkid: item.PackageId,
                pkname: item.PackageName,
                id: item.ProductId,
                dpr: dpr,
                rp: rp,
                dprtxt: item.DownPaymentText,
                dprn: item.DownPaymentNum,
                tctxt: item.TotalCostText,
                irt: item.InterestRateText,
                mptxt: item.MonthlyPaymentText,
                titxt: item.TotalInterestText,
                lat: item.LoanAmountText,
                lan: item.LoanAmountNum,
                totalpay: item.TotalPay
            });
            obj[pkid].rps.push(rp);
            obj[pkid].dprs.push(dpr);
        }

        var bestPlan = [];
        for (var sortitem in obj) {
            obj[sortitem].rps = this.unique(obj[sortitem].rps).sort();
            obj[sortitem].dprs = this.unique(obj[sortitem].dprs).sort();
            obj[sortitem].products = this.sortProducts(obj[sortitem].products);
            bestPlan.push(obj[sortitem].products[0]);
        }
        that.data = obj;
        console.log(obj);
        bestPlan = this.sortProducts(bestPlan);
        this.createPlans(bestPlan);
    },
    sortProducts: function(products) {
        var result = products.sort(function(a, b) {
            if (a.dpr < b.dpr && a.rp < b.rp) {
                return -1;
            }
            return 1;
        });

        console.log(result);
        return result;
    },
    createPlans: function(bestPlan) {
        var that = this;
        console.log('---------------bestPlan---------------');
        console.log(bestPlan)
        var packageformat = '<li class="{active}"><div class="pop_title">{pkname}<span>宽松</span></div><div class="pop_main"><span>首付{dpr}起 : <i class="orange">{dprtxt}</i></span> <span class="float_span">月供{rp}期 : <i class="black">{mptxt}</i></span></div></li>';
        var frag = '',
            packageLi = '',
            product = undefined;

        for (var i = 0, len = bestPlan.length; i < len; i++) {
            product = bestPlan[i];
            if (!product) { return false; }
            packageLi = packageformat.format({
                active: i === 0 ? 'active' : '',
                pkname: product.pkname,
                dpr: product.dpr * 100 + "%",
                dprtxt: product.dprtxt,
                rp: product.rp,
                mptxt: product.mptxt
            });
            that.createRulerGroup(product.pkid, i);
            frag += packageLi;
        }
        document.querySelector('#package-wrapper').innerHTML = frag;
    },
    createRuler: function(options) {
        var div = document.createElement('div');
        div.id = options.pkid;
        div.className = options.className;
        div.innerHTML = '<h3>' + options.title + '</h3><span class="' + options.subclass + '"></span><div class="progress"><div class="progress-bar-wrapper"><div class="progress-bar progress-bar-bc"></div><div class="progress-bar progress-bar-active"></div></div><div class="progress-btn"></div></div><ul class="ratio"></ul>';
        return div;
    },
    createRulerGroup: function(pkid, index) {
        var that = this;
        /*首付*/
        var dprtxtid = "dprtxt" + pkid;
        var dprtxt = this.createRuler({
            pkid: dprtxtid,
            className: 'ruler',
            title: '首付',
            subclass: 'dprtxt' //mptxt  ,dprtxt
        });
        /*月供*/
        var mptxtid = "mptxt" + pkid;
        var mptxt = this.createRuler({
            pkid: "mptxt" + pkid,
            className: 'ruler ruler2',
            title: '月供',
            subclass: 'mptxt' //mptxt  ,dprtxt
        });
        var div = document.createElement('div');
        if (index !== 0) {
            div.style.display = "none";
        }
        div.appendChild(dprtxt);
        div.appendChild(mptxt);
        document.querySelector('#package-rulers-wrapper').appendChild(div);

        that.bindRulerEvent(dprtxtid, mptxtid, index, pkid);
    },
    bindRulerEvent: function(dprtxtid, mptxtid, index, pkid) {
        var that = this;
        (function(dprtxtid, mptxtid, index, pkid, that) {
            /*首付*/

            var dpr = 0; // data.dprs[0];
            var rp = 0; // data.rps[0];
            var mptxtidRuler = null;
            var dprtxtidRuler = null;
            var totaldata = that.data,
                rulerData = totaldata[pkid];

            dprtxtidRuler = new Ruler({
                data: rulerData,
                rulerid: dprtxtid,
                ratioText: rulerData.dprs,
                ratioindex: 0,
                titleFn: function(value) {
                    return value * 100 + "%";
                },
                onstart: null,
                onmove: null,
                onend: function(options) {
                    console.log(options);
                    dpr = options.data.dprs[options.ratioindex];
                    var result = findProduct(dpr, rp, options.data.products, 0);
                    showResult(result, pkid);
                    var position = mptxtidRuler.settings.ratioText.indexOf(result.rp);
                    mptxtidRuler.setposition(position);
                }
            });



            /*分期*/
            mptxtidRuler = new Ruler({
                data: rulerData,
                rulerid: mptxtid,
                ratioText: rulerData.rps,
                ratioindex: rulerData.rps.length - 1,
                titleFn: function(value) {
                    return value + "期";
                },
                onafterinit: function(data) {
                    console.log('-------------');
                    console.log(data);
                    dpr = data.dprs[0];
                    var rps = data.rps;
                    rp = rps[rps.length - 1];
                    var result = findProduct(dpr, rp, data.products, 1);
                    showResult(result, pkid);
                },
                onstart: null,
                onmove: null,
                onend: function(options) {
                    console.log(options);
                    console.log(dprtxtidRuler);
                    rp = options.data.rps[options.ratioindex];
                    var result = findProduct(dpr, rp, options.data.products, 1);
                    var position = dprtxtidRuler.settings.ratioText.indexOf(result.dpr);
                    showResult(result, pkid);
                    dprtxtidRuler.setposition(position);
                }
            });

            if (index === 0) {
                console.log('==========================');
                dprtxtidRuler.init();
                mptxtidRuler.init();
            }
            that.rulersEvent.push({
                dprtxtidRuler: dprtxtidRuler,
                mptxtidRuler: mptxtidRuler
            });
        })(dprtxtid, mptxtid, index, pkid, that);
    }
};
dealwithdata.init(planArr);
console.log(dealwithdata);

function findProduct(dpr, rp, products, type) {
    var item = undefined,
        result = null;
    for (var i = 0, len = products.length; i < len; i++) {
        item = products[i];
        if (item.dpr === dpr && item.rp === rp) {
            result = item;
            break;
        }
    }
    if (!result) {
        result = null;
        for (var i = 0, len = products.length; i < len; i++) {
            item = products[i];
            if (type === 0 && item.dpr === dpr) {
                result = item;
                break;
            }
            if (type === 1 && item.rp === rp) {
                result = item;
                break;
            }
        }
    }
    return result;
}

function showResult(result, pkid) {
    console.log(result);
    var dprtxtid = "#dprtxt" + pkid;
    var mptxtid = "#mptxt" + pkid;

    $(mptxtid).find('.mptxt').text(result.mptxt);
    $(dprtxtid).find('.dprtxt').text(result.dprtxt);
    $("#total-right .dprtxt").text(result.dprtxt);
    $("#total-right .tctxt").text(result.tctxt);
    $("#total-right .lat").text(result.lat);
    $("#totalpay").text("￥" + result.totalpay);
    var ctx = document.getElementById("myChart").getContext('2d');
    var pieData = [result.dprn, result.lan, result.totalpay];

    var chartOptions = {
        type: 'doughnut',
        data: {
            datasets: [{
                backgroundColor: [
                    "#4F4F4F",
                    "#9B9B9B",
                    "#D2AE65"
                ],
                data: pieData //首付，贷款额度，贷款成本
            }]
        },
        options: {
            tooltips: {
                enabled: false //去掉tooltips
            }
        }
    };
    console.log(pieData);
    new Chart(ctx, chartOptions)
}

$(function() {
    $(".loan-trigger").click(function() {
        // body... 
        $("#shadow,#loan-plan").show();
    });
    $("#total_font").click(function () {
       $("#shadow,#tab_total").show();
    });
});

var Loan = function(opts) {
    this.mask = $("#shadow");
    this.loan = $("#loan-plan");
    this.close = $("#loan-plan .icon-Close-01");
    this.plan = $("#package-wrapper li");
    this.planCallback = opts.planCallback;
};
Loan.prototype = {
    init: function() {
        this.bindEvent();
    },
    bindEvent: function() {
        var that = this;
        //关闭
        that.close.click(function() {
            that.hide();
        });
        //点击li
        console.log(that.plan);
        that.plan.click(function() {
            var thisplan = $(this);
            var index = thisplan.index();
            console.log(index);
            if (!thisplan.hasClass('active')) {
                thisplan.addClass('active').siblings('li').removeClass('active');
                $("#package-rulers-wrapper>div").eq(index).show().siblings().hide();
                if (index !== 0 && !thisplan.hasClass('over')) {
                    thisplan.addClass('over');
                    var events = dealwithdata.rulersEvent[index];
                    events.dprtxtidRuler.init();
                    events.mptxtidRuler.init();
                }
            }
            setTimeout(function() {
                that.hide();
            }, 300);

        });
    },
    hide: function() {
        this.mask.hide();
        this.loan.hide();
    },
    show: function() {
        this.mask.show();
        this.loan.show();
    }
}

var load = new Loan({
    planCallback: function() {
        console.log(ruler1);
    }
});
load.init();